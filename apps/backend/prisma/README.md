# Prisma Database Setup

## Первоначальная настройка

1. **Установите зависимости:**
   ```bash
   npm install
   ```

2. **Настройте подключение к БД:**
   - Скопируйте `.env.example` в `.env`
   - Укажите правильные параметры подключения к MS SQL Server:
     ```env
     DATABASE_URL="sqlserver://localhost:1433;database=autotrack_dev;user=sa;password=YourPassword;encrypt=false;trustServerCertificate=true"
     ```

3. **Создайте базу данных:**
   - Подключитесь к SQL Server и создайте базу данных:
     ```sql
     CREATE DATABASE autotrack_dev;
     ```

4. **Сгенерируйте Prisma Client:**
   ```bash
   npm run db:generate
   ```

5. **Примените миграции (создаст таблицы):**
   ```bash
   npm run db:migrate
   ```
   Это создаст первую миграцию и применит её к БД.

6. **Заполните тестовыми данными (опционально):**
   ```bash
   npm run db:seed
   ```

## Работа с миграциями

### Создание новой миграции после изменения схемы

1. Измените `schema.prisma`
2. Создайте и примените миграцию:
   ```bash
   npm run db:migrate
   ```
   Prisma автоматически создаст файл миграции в `prisma/migrations/`

### Применение миграций в production

```bash
npm run db:migrate:deploy
```

### Быстрое обновление схемы (только для разработки)

Если нужно быстро протестировать изменения без создания миграции:
```bash
npm run db:push
```
⚠️ **Внимание:** `db:push` не создает файлы миграций, используйте только для разработки!

## Просмотр данных

Откройте Prisma Studio для визуального просмотра БД:
```bash
npm run db:studio
```

## Частые изменения схемы

Схема спроектирована для частых изменений:
- Все связи используют `onDelete: Cascade` где уместно
- Индексы добавлены для производительности
- UUID используются для ID (легко масштабируется)
- Опциональные поля там, где это возможно

При изменении схемы:
1. Измените `schema.prisma`
2. Запустите `npm run db:migrate`
3. Prisma автоматически сгенерирует SQL для миграции
4. Проверьте сгенерированный SQL в `prisma/migrations/`
5. При необходимости отредактируйте миграцию вручную

## Структура базы данных

Основные таблицы:
- `users` - пользователи системы
- `orders` - заказы на ремонт
- `order_stages` - этапы выполнения заказа
- `service_templates` - шаблоны услуг
- `stage_templates` - шаблоны этапов
- `inventory_items` - комплектующие и расходники
- `stage_comments` - комментарии к этапам
- `stage_attachments` - фото/отчеты по этапам
- `notifications` - уведомления





